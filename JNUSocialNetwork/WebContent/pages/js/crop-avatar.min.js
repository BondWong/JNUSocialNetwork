!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){"use strict";function i(i,e){this.setDefaults(e),this.$container=i,this.$avatarView=this.$container.find(".show-view"),this.$avatar=this.$avatarView.find("img"),this.$avatarModal=this.$container,this.$loading=t.find(".loading"),this.$avatarForm=this.$avatarModal.find(".avatar-form"),this.$avatarUpload=this.$avatarForm.find(".avatar-upload"),this.$avatarSrc=this.$avatarForm.find(".avatar-src"),this.$avatarData=this.$avatarForm.find(".avatar-data"),this.$avatarInput=this.$avatarForm.find(".avatar-input"),this.$avatarSave=this.$avatarForm.find(".avatar-save"),this.$avatarWrapper=this.$avatarModal.find(".avatar-wrapper"),this.$avatarPreview=this.$avatarModal.find(".avatar-preview"),this.init(),a(this)}var a=function(t){try{console.log(t)}catch(a){}};i.defaults={aspectRatio:1,imgPreferredSize:2,imgUrlAttrName:"avatarLink"},i.prototype={constructor:i,setDefaults:function(a){t.extend(this.defaults,a)},support:{fileList:!!t('<input type="file">').prop("files"),fileReader:!!window.FileReader,formData:!!window.FormData},init:function(){this.support.datauri=this.support.fileList&&this.support.fileReader,this.support.formData||this.initIframe(),this.initModal(),this.addListener()},initModal:function(){this.$avatarModal.modal("hide"),this.initPreview()},initPreview:function(){var t=this.$avatar.attr("src");this.$avatarPreview.empty().html('<img src="'+t+'">')},initIframe:function(){var a="avatar-iframe-"+Math.random().toString().replace(".",""),i=t('<iframe name="'+a+'" style="display:none;"></iframe>'),e=!0,r=this;this.$iframe=i,this.$avatarForm.attr("target",a).after(i),this.$iframe.on("load",function(){var t,a,i;try{a=this.contentWindow,i=this.contentDocument,i=i?i:a.document,t=i?i.body.innerText:null}catch(s){}t?r.submitDone(t):e?e=!1:r.submitFail("Image upload failed!"),r.submitEnd()})},addListener:function(){this.$avatarView.on("click",t.proxy(this.click,this)),this.$avatarInput.on("change",t.proxy(this.change,this)),this.$avatarForm.on("submit",t.proxy(this.submit,this))},click:function(){this.$avatarModal.modal("show")},change:function(){var t,a;this.support.datauri?(t=this.$avatarInput.prop("files"),t.length>0&&(a=t[0],this.isImageFile(a)&&this.validateImgSize(a)&&this.read(a))):(a=this.$avatarInput.val(),this.isImageFile(a)&&this.validateImgSize(a)&&this.syncUpload())},isImageFile:function(t){return t.type?/^image\/\w+$/.test(t.type):/\.(jpg|jpeg|png|gif)$/.test(t)},validateImgSize:function(t){return t.size>1024*this.defaults.imgPreferredSize*1024?(alert("file size overflow"),!1):!0},read:function(t){var a=this,i=new FileReader;i.readAsDataURL(t),i.onload=function(){a.url=this.result,a.startCropper()}},startCropper:function(){var i=this;this.active?this.$img.cropper("setImgSrc",this.url):(this.$img=t('<img src="'+this.url+'">'),this.$avatarWrapper.empty().html(this.$img),this.$img.cropper({aspectRatio:this.defaults.aspectRatio,preview:this.$avatarPreview.selector,done:function(t){a("crop-data: "+t),i.$avatarData.val(JSON.stringify(t))}}),this.active=!0)},stopCropper:function(){this.active&&(this.$img.cropper("disable"),this.$img.data("cropper",null).remove(),this.active=!1)},cropDone:function(){this.$avatarSrc.val(""),this.$avatarData.val(""),this.$avatar.attr("src",this.url),this.stopCropper(),this.$avatarModal.modal("hide")},ajaxUpload:function(){var a=this.$avatarForm.attr("action"),i=new FormData(this.$avatarForm[0]),e=this;t.ajax(a,{type:"post",data:i,processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",USERID),e.submitStart()},success:function(t){e.submitDone(t)},error:function(t,a,i){e.submitFail(a||i)},complete:function(){e.submitEnd()}})},syncUpload:function(){this.$avatarSave.click()},submit:function(){return this.$avatarSrc.val()||this.$avatarInput.val()?this.support.formData?(this.ajaxUpload(),!1):void 0:!1},submitStart:function(){this.$loading.fadeIn()},submitDone:function(i){a(i);try{i=t.parseJSON(i)}catch(e){}if(i)if(i.src){if(this.url=i.src,a("response url = "+this.url),this.support.datauri||this.uploaded){this.uploaded=!1;var r={};r[this.defaults.imgUrlAttrName]=this.url,UpdateUserProfile(userID,t.toJSON(r)),this.cropDone()}else this.uploaded=!0,this.$avatarSrc.val(this.url),this.startCropper();this.$avatarInput.val("")}else i.message&&this.alert(i.message);else this.alert("Failed to response")},submitFail:function(t){this.alert(t)},submitEnd:function(){this.$loading.fadeOut()},alert:function(t){var a=['<div class="alert alert-danger avater-alert">','<button type="button" class="close" data-dismiss="alert">&times;</button>',t,"</div>"].join("");this.$avatarUpload.after(a)}},window.CropAvatar=i});