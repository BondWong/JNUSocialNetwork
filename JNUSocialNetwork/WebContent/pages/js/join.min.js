!function(t){"use strict";function r(){t.getJSON(i).done(function(n){for(var i in n)t.getJSON(e+n[i]).done(g)})}function l(){t("#activity-list").delegate(".join-btn","click",function(e){if(!window.USERID)return void t("#remindModal").modal("show");var n=t(e.currentTarget),i=c[n.data("postid")];t.inArray(window.USERID,i.participantIDs)>=0?f(n):d(n)}),t(".account-link").click(function(t){localStorage.setItem("url",window.location.href),window.location.href=t.currentTarget.getAttribute("href"),console.log(window.location.href)})}function d(e){t.getJSON(n+window.USERID).done(function(n){n.attributes.telnum?u(e):(t("#checkTN").data("postid",e.data("postid")),t("#addPhoneModal").modal("show"),t("#checkTN").click(function(){var i=t("#telnum").val();if(i>=10000000001){var a={telnum:i};t.ajax(o+window.USERID,{type:"PUT",data:JSON.stringify(a),contentType:"application/json",beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(){u(e)},error:function(t,e,n){console.log("add Phone failed! "+e+" "+n)}})}return!1}))})}function u(e){var n=[a,window.USERID,"/",e.data("postid")].join("");t.ajax(n,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(n,i){console.log("join succeed! "+i),w(e),D(t("#successAlert"),"亲！你已成功加入该活动"),p(e.data("postid"))},error:function(e,n,i){console.log("join failed! "+n+" "+i),D(t("#errorAlert"),"未知错误，加入失败，抱歉！")}})}function f(e){var n=[s,window.USERID,"/",e.data("postid")].join("");t.ajax(n,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(n,i){console.log("leave succeed "+i),w(e),D(t("#successAlert"),"亲！很遗憾你放弃了参加这次活动！"),p(e.data("postid"))},error:function(e,n,i){console.log("leave failed! "+n+" "+i),D(t("#errorAlert"),"亲！未知错误，上天也阻止你放弃啊！")}})}function p(n){t.getJSON(e+n).done(function(t){c[t.ID]=t})}function w(t){t.hasClass("btn-success")?t.removeClass("btn-success").addClass("btn-danger").html("离开"):t.removeClass("btn-danger").addClass("btn-success").html("参加")}function g(e){var n={activityAddr:e.attributes.activityAddr,activityMore:e.attributes.activityMore,activityName:e.attributes.activityName,activityTime:e.attributes.activityTime,imgsrc:JSON.parse(e.attributes.background).src,ID:e.ID};c[e.ID]=e;var i=_.template(t("#li-template").html())(n),a=t(i);t.inArray(window.USERID,e.participantIDs)>=0?w(t(".join-btn",a)):e.participantIDs.length===e.attributes.limitation&&t(".join-btn",a).prop("disabled",!0).html("人数已满"),e.attributes.startDate-(new Date).getTime()<=0&&t(".join-btn",a).prop("disabled",!0).html("已过期"),console.log(a.get(0)),t("#activity-list").append(a[0])}function D(e,n){n&&t("p",e).html(n),e.fadeIn(500),setTimeout(function(){e.fadeOut(500)},4e3)}var e="/app/post/fetchByID/",n="/app/user/fetchByID/",i="/pages/assets/postID.json",a="/app/post/joinActivity/",o="/app/user/updateProfile/",s="/app/post/leaveActivity/",c={};t(document).ready(function(){_.templateSettings={evaluate:/<@([\s\S]+?)@>/g,interpolate:/<@=([\s\S]+?)@>/g,escape:/<@-([\s\S]+?)@>/g},r(),l()})}(jQuery);