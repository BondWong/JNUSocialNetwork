!function(t){"use strict";function r(){t.getJSON(n).done(function(i){for(var n in i)t.getJSON(e+i[n]).done(g)})}function l(){t("#activity-list").delegate(".join-btn","click",function(e){if(!window.USERID)return void t("#remindModal").modal("show");var i=t(e.currentTarget),n=c[i.data("postid")];t.inArray(window.USERID,n.participantIDs)>=0?f(i):d(i)}),t(".account-link").click(function(t){localStorage.setItem("url",window.location.href),window.location.href=t.currentTarget.getAttribute("href"),console.log(window.location.href)})}function d(e){t.getJSON(i+window.USERID).done(function(i){i.attributes.telnum?u(e):(t("#checkTN").data("postid",e.data("postid")),t("#addPhoneModal").modal("show"),t("#checkTN").click(function(){var n=t("#telnum").val();n>=10000000001&&t.ajax(o+window.USERID,{type:"POST",data:{telnum:n},processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(){u(e)}})}))})}function u(e){var i=[a,window.USERID,"/",e.data("postid")].join("");t.ajax(i,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(i,n){console.log("join succeed! "+n),D(e),m(t("#successAlert"),"亲！你已成功加入该活动"),p(e.data("postid"))},error:function(e,i,n){console.log("join failed! "+i+" "+n),m(t("#errorAlert"),"未知错误，加入失败，抱歉！")}})}function f(e){var i=[s,window.USERID,"/",e.data("postid")].join("");t.ajax(i,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",window.USERID)},success:function(i,n){console.log("leave succeed "+n),D(e),m(t("#successAlert"),"亲！很遗憾你放弃了参加这次活动！"),p(e.data("postid"))},error:function(e,i,n){console.log("leave failed! "+i+" "+n),m(t("#errorAlert"),"亲！未知错误，上天也阻止你放弃啊！")}})}function p(i){t.getJSON(e+i).done(function(t){c[t.ID]=t})}function D(t){t.hasClass("btn-success")?t.removeClass("btn-success").addClass("btn-danger").html("离开"):t.removeClass("btn-danger").addClass("btn-success").html("参加")}function g(e){var i={activityAddr:e.attributes.activityAddr,activityMore:e.attributes.activityMore,activityName:e.attributes.activityName,activityTime:e.attributes.activityTime,imgsrc:JSON.parse(e.attributes.background).src,ID:e.ID};c[e.ID]=e;var n=_.template(t("#li-template").html())(i),a=t(n);t.inArray(window.USERID,e.participantIDs)>=0?D(t(".join-btn",a)):e.participantIDs.length===e.attributes.limitation&&t(".join-btn",a).prop("disabled",!0).html("人数已满"),e.attributes.startDate-(new Date).getTime()<=0&&t(".join-btn",a).prop("disabled",!0).html("已过期"),console.log(a.get(0)),t("#activity-list").append(a[0])}function m(e,i){i&&t("p",e).html(i),e.fadeIn(500),setTimeout(function(){e.fadeOut(500)},4e3)}var e="/app/post/fetchByID/",i="/app/user/fetchByID/",n="/pages/assets/postID.json",a="/app/post/joinActivity/",o="/app/user/updateProfile/",s="/app/post/leaveActivity/",c={};t(document).ready(function(){_.templateSettings={evaluate:/<@([\s\S]+?)@>/g,interpolate:/<@=([\s\S]+?)@>/g,escape:/<@-([\s\S]+?)@>/g},r(),l()})}(jQuery);