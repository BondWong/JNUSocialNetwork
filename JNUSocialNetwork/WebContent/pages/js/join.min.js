!function(t){"use strict";function s(){t.getJSON(i).done(function(i){for(var n in i)t.getJSON(e+i[n]).done(f)})}function c(){t("#activity-list").delegate(".join-btn","click",function(e){if(!window.USERID)return void t("#remindModal").modal("show");var i=t(e.currentTarget),n=o[i.data("postid")];t.inArray(window.USERID,n.participantIDs)>=0?l(i):r(i)}),t(".account-link").click(function(t){localStorage.setItem("url",window.location.href),window.location.href=t.currentTarget.getAttribute("href"),console.log(window.location.href)})}function r(e){var i=[n,window.USERID,"/",e.data("postid")].join("");t.ajax(i,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",USERID)},success:function(i,n){console.log("join succeed! "+n),d(e),p(t("#successAlert"),"亲！你已成功加入该活动"),u(e.data("postid"))},error:function(e,i,n){console.log("join failed! "+i+" "+n),p(t("#errorAlert"),"未知错误，加入失败，抱歉！")}})}function l(e){var i=[a,window.USERID,"/",e.data("postid")].join("");t.ajax(i,{type:"PUT",processData:!1,contentType:!1,beforeSend:function(t){t.setRequestHeader("ID",USERID)},success:function(i,n){console.log("leave succeed "+n),d(e),p(t("#successAlert"),"亲！很遗憾你放弃了参加这次活动！"),u(e.data("postid"))},error:function(e,i,n){console.log("leave failed! "+i+" "+n),p(t("#errorAlert"),"亲！未知错误，上天也阻止你放弃啊！")}})}function u(i){t.getJSON(e+i).done(function(t){o[t.ID]=t})}function d(t){t.hasClass("btn-success")?t.removeClass("btn-success").addClass("btn-danger").html("离开"):t.removeClass("btn-danger").addClass("btn-success").html("参加")}function f(e){var i={activityAddr:e.attributes.activityAddr,activityMore:e.attributes.activityMore,activityName:e.attributes.activityName,activityTime:e.attributes.activityTime,imgsrc:JSON.parse(e.attributes.background).src,ID:e.ID};o[e.ID]=e;var n=_.template(t("#li-template").html())(i),a=t(n);t.inArray(window.USERID,e.participantIDs)>=0&&d(t(".join-btn",a)),e.participantIDs.length===e.attributes.limitation&&t(".join-btn",a).prop("disabled",!0).html("人数已满"),e.attributes.startDate-(new Date).getTime()<=0&&t(".join-btn",a).prop("disabled",!0).html("已过期"),console.log(a.get(0)),t("#activity-list").append(a[0])}function p(e,i){i&&t("p",e).html(i),e.fadeIn(500),setTimeout(function(){e.fadeOut(500)},4e3)}var e="/app/post/fetchByID/",i="/pages/assets/postID.json",n="/app/post/joinActivity/",a="/app/post/leaveActivity/",o={};t(document).ready(function(){_.templateSettings={evaluate:/<@([\s\S]+?)@>/g,interpolate:/<@=([\s\S]+?)@>/g,escape:/<@-([\s\S]+?)@>/g},s(),c()})}(jQuery);